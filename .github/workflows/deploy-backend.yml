name: Deploy Backend to EC2

on:
  push:
    branches:
      - develop  # Production deployment branch

# Prevent concurrent deployments to the same environment
concurrency:
  group: deploy-backend-${{ github.ref }}
  cancel-in-progress: true

env:
  DOCKER_IMAGE: ${{ vars.DOCKERHUB_USERNAME }}/myce-backend
  DOCKER_TAG: ${{ github.sha }}
  EC2_HOST: ${{ vars.EC2_HOST }}
  EC2_USER: ${{ vars.EC2_USER || 'ubuntu' }}
  AWS_REGION: ${{ vars.AWS_REGION || 'ap-northeast-2' }}

jobs:
  build-and-deploy:
    name: Build Docker Image and Deploy to EC2
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: ğŸ”§ Make gradlew executable
        run: chmod +x ./gradlew

      - name: ğŸ§ª Run tests (skipped for now)
        run: echo "Tests skipped - will configure later"
        # TODO: Configure test profile with embedded H2 database
        # run: ./gradlew test

      - name: ğŸ“¦ Build JAR
        run: ./gradlew bootJar

      - name: ğŸ§¹ Verify build output
        run: |
          echo "Build completed. Checking JAR file:"
          ls -la build/libs/
          echo "JAR file size:"
          du -sh build/libs/*.jar

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ğŸ—ï¸ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
            ${{ env.DOCKER_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ğŸš€ Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.EC2_HOST }}
          username: ${{ env.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: |
            set -e
            
            echo "ğŸ“ Navigating to backend directory..."
            cd /home/ubuntu/apps/backend
            
            echo "ğŸ§¹ Stopping existing container..."
            docker stop myce-backend || true
            docker rm myce-backend || true
            
            echo "â¬‡ï¸ Pulling latest image..."
            docker pull ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
            
            echo "ğŸš€ Running new container with self-managed environment variables..."
            echo "Container will fetch secrets from AWS SSM Parameter Store on startup"
            docker run -d \
              --name myce-backend \
              --restart unless-stopped \
              -p 8080:8080 \
              ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
            
            echo "â±ï¸ Waiting for container to start..."
            sleep 15
            
            echo "ğŸ§¹ Cleaning up old images (keeping last 3 versions)..."
            docker images ${{ env.DOCKER_IMAGE }} --format "table {{.Tag}}\t{{.ID}}" | grep -v "TAG" | tail -n +4 | awk '{print $2}' | xargs -r docker rmi || true

      - name: ğŸ¥ Health Check
        run: |
          echo "ğŸ¥ Performing health check with intelligent retry..."
          MAX_ATTEMPTS=15
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Health check attempt $ATTEMPT/$MAX_ATTEMPTS..."
            
            # Primary: Test production ALB endpoint (end-to-end)
            if curl -f -m 10 https://api.myce.live/actuator/health; then
              echo "âœ… Health check passed via ALB on attempt $ATTEMPT!"
              exit 0
            fi
            
            echo "âŒ ALB failed, trying direct EC2 endpoint..."
            # Fallback: Test direct container health
            if curl -f -m 10 http://${{ env.EC2_HOST }}:8080/actuator/health; then
              echo "âœ… Health check passed via direct EC2 on attempt $ATTEMPT!"
              echo "âš ï¸  Note: ALB might need more time to detect healthy targets"
              exit 0
            fi
            
            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "âŒ Health check failed after $MAX_ATTEMPTS attempts (2.5 minutes)"
              echo "ğŸ” Server may still be starting up. Check container logs:"
              echo "   ssh ubuntu@${{ env.EC2_HOST }} 'docker logs myce-backend --tail 50'"
              exit 1
            fi
            
            echo "â³ Server not ready, waiting 10s... ($(($MAX_ATTEMPTS - $ATTEMPT)) attempts remaining)"
            sleep 10
            ATTEMPT=$((ATTEMPT + 1))
          done

      - name: ğŸ‰ ë°±ì—”ë“œ ë°°í¬ ì„±ê³µ ì•Œë¦¼
        if: success()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_MESSAGE: |
            ğŸ‰ *ë°±ì—”ë“œ ë°°í¬ ì™„ë£Œ!*
            
            ğŸ³ **Docker ì´ë¯¸ì§€:** ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
            ğŸ–¥ï¸ **EC2 í˜¸ìŠ¤íŠ¸:** ${{ env.EC2_HOST }}
            ğŸŒ **API URL:** http://${{ env.EC2_HOST }}:8080
            ğŸ“ **ë¸Œëœì¹˜:** ${{ github.ref_name }}
            ğŸ‘¤ **ë°°í¬ì:** ${{ github.actor }}
            ğŸ¥ **í—¬ìŠ¤ì²´í¬:** âœ… í†µê³¼
            
            ğŸ”— **API í…ŒìŠ¤íŠ¸:** http://${{ env.EC2_HOST }}:8080/actuator/health
          SLACK_TITLE: 'Myce ë°±ì—”ë“œ ë°°í¬'
          SLACK_COLOR: 'good'
          SLACK_USERNAME: 'GitHub Actions'
          SLACK_ICON: ':rocket:'

      - name: âŒ ë°±ì—”ë“œ ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
        if: failure()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_MESSAGE: |
            âŒ *ë°±ì—”ë“œ ë°°í¬ ì‹¤íŒ¨*
            
            ğŸ³ **Docker ì´ë¯¸ì§€:** ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
            ğŸ–¥ï¸ **EC2 í˜¸ìŠ¤íŠ¸:** ${{ env.EC2_HOST }}
            ğŸ“ **ë¸Œëœì¹˜:** ${{ github.ref_name }}
            ğŸ‘¤ **ì‹œë„í•œ ì‚¬ëŒ:** ${{ github.actor }}
            ğŸ” **ë¡œê·¸ í™•ì¸:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          SLACK_TITLE: 'Myce ë°±ì—”ë“œ ë°°í¬'
          SLACK_COLOR: 'danger'
          SLACK_USERNAME: 'GitHub Actions'
          SLACK_ICON: ':x:'